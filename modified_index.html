<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Agentic Demo Viewer - Strands Integration</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.14/dist/hls.min.js"></script>
  <style>
    :root { --panel-bg: rgba(10,10,10,0.7); --accent: #36d38c; --text: #e9eef3; }
    html,body { height: 100%; margin: 0; background: #000; color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;}
    #container { position: relative; width: 100%; height: 100%; display: grid; place-items: center; }
    video { width: 100%; height: 100%; object-fit: contain; background: #000; }
    #toast { position: absolute; bottom: 16px; left: 50%; transform: translateX(-50%); background: var(--panel-bg); color: var(--text); padding: 10px 14px; border-radius: 8px; font-size: 13px; border: 1px solid rgba(255,255,255,0.08); opacity: 0; transition: opacity 200ms ease-in-out; }
    #toast.show { opacity: 1; }

    /* Control Panel with Tabs (left side) */
    .panel {
      position: absolute;
      top: 16px;
      left: 16px;
      z-index: 5;
      background: var(--panel-bg);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 8px;
      width: 380px;
      max-height: 72vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      backdrop-filter: blur(2px);
    }
    .tabs { display: flex; }
    .tab-btn {
      flex: 1;
      background: transparent;
      color: var(--text);
      border: none;
      padding: 8px 10px;
      cursor: pointer;
      font-weight: 600;
      letter-spacing: 0.3px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .tab-btn.active {
      color: var(--accent);
      border-bottom: 2px solid var(--accent);
      background: rgba(54,211,140,0.08);
    }
    .tab { display: none; padding: 10px 12px; overflow: auto; max-height: 60vh; }
    .tab.active { display: block; }
    
    /* Persona card styles */
    .persona-card { border: 1px solid rgba(255,255,255,0.12); border-radius: 8px; background: rgba(15,15,15,0.6); overflow: hidden; margin-bottom: 12px; }
    .persona-summary { padding: 12px; cursor: pointer; transition: background 200ms; }
    .persona-summary:hover { background: rgba(54,211,140,0.05); }
    .persona-name { font-weight: 700; font-size: 16px; color: var(--accent); letter-spacing: 0.5px; }
    .persona-tagline { font-size: 13px; color: #9fb0c0; margin-top: 4px; }
    .persona-details { max-height: 0; overflow: hidden; transition: max-height 300ms ease; }
    .persona-details.expanded { max-height: 500px; }
    .persona-section { padding: 10px 12px; border-top: 1px solid rgba(255,255,255,0.06); }
    .section-title { font-size: 11px; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; font-weight: 600; margin-bottom: 6px; }
    .section-text { font-size: 13px; color: var(--text); line-height: 1.4; }

    /* Turn Control styles */
    .turn-control {
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 8px;
      background: rgba(15,15,15,0.6);
      padding: 12px;
      margin-bottom: 12px;
    }
    .turn-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .turn-title { font-weight: 700; font-size: 14px; color: var(--accent); }
    .turn-status {
      font-size: 11px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 4px;
      text-transform: uppercase;
    }
    .status-ready { background: rgba(54,211,140,0.2); color: var(--accent); }
    .status-running { background: rgba(255,193,7,0.2); color: #ffc107; }
    .status-completed { background: rgba(40,167,69,0.2); color: #28a745; }
    .status-error { background: rgba(220,53,69,0.2); color: #dc3545; }

    .prompt-input {
      width: 100%;
      background: #0b1b26;
      border: 1px solid rgba(255,255,255,0.12);
      color: var(--text);
      border-radius: 6px;
      padding: 8px 10px;
      font-size: 13px;
      margin-bottom: 8px;
      resize: vertical;
      min-height: 60px;
    }
    .turn-actions {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    .run-turn-btn {
      background: var(--accent);
      color: #0b1b26;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      font-weight: 600;
      cursor: pointer;
      flex: 1;
      font-size: 14px;
    }
    .run-turn-btn:disabled {
      background: #666;
      cursor: not-allowed;
    }
    .persona-select {
      background: #0b1b26;
      border: 1px solid rgba(255,255,255,0.12);
      color: var(--text);
      border-radius: 6px;
      padding: 6px 8px;
      font-size: 12px;
      flex: 1;
    }

    .turn-result {
      background: rgba(5,5,5,0.8);
      border-radius: 6px;
      padding: 10px;
      margin-top: 8px;
      max-height: 200px;
      overflow-y: auto;
    }
    .result-text {
      font-size: 13px;
      color: var(--text);
      line-height: 1.4;
      margin-bottom: 8px;
    }
    .result-meta {
      font-size: 11px;
      color: #9fb0c0;
      border-top: 1px solid rgba(255,255,255,0.06);
      padding-top: 6px;
    }
    .s3-link {
      color: var(--accent);
      text-decoration: none;
      margin-right: 12px;
    }
    .s3-link:hover { text-decoration: underline; }

    /* Stream of consciousness styles */
    .consciousness-stream { height: 100%; display: flex; flex-direction: column; }
    .stream-header { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; border-bottom: 1px solid rgba(255,255,255,0.08); }
    .stream-title { font-size: 13px; font-weight: 600; color: var(--text); }
    .stream-status { font-size: 11px; color: #ef4444; font-weight: 600; }
    .stream-content { flex: 1; padding: 12px; overflow-y: auto; max-height: 50vh; background: rgba(5,5,5,0.8); border-radius: 6px; margin: 8px; }
    .stream-line { font-size: 13px; color: var(--text); line-height: 1.5; font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace; margin-bottom: 8px; }
    .cursor { display: inline-block; width: 2px; height: 1em; background: var(--accent); animation: blink 1s infinite; margin-left: 2px; }
    @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0; } }

    /* History styles */
    .history-item {
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 6px;
      padding: 8px;
      margin-bottom: 6px;
      background: rgba(5,5,5,0.4);
    }
    .history-prompt {
      font-size: 12px;
      color: #9fb0c0;
      margin-bottom: 4px;
    }
    .history-response {
      font-size: 13px;
      color: var(--text);
      margin-bottom: 4px;
    }
    .history-meta {
      font-size: 11px;
      color: #666;
    }
  </style>
</head>
<body>
 <div id="container">
   <video id="player" playsinline muted autoplay></video>
   <div id="toast"></div>

   <!-- Control panel with tabs -->
   <div id="controlPanel" class="panel" aria-label="Control panel">
     <div class="tabs">
       <button class="tab-btn active" data-tab="t-control">Agent Control</button>
       <button class="tab-btn" data-tab="t-persona">Persona</button>
       <button class="tab-btn" data-tab="t-stream">Stream</button>
       <button class="tab-btn" data-tab="t-history">History</button>
     </div>

     <!-- Agent Control Tab -->
     <div id="t-control" class="tab active">
       <div class="turn-control">
         <div class="turn-header">
           <div class="turn-title">Strands Agent Control</div>
           <div id="turnStatus" class="turn-status status-ready">Ready</div>
         </div>
         
         <textarea id="promptInput" class="prompt-input" placeholder="Enter command for your Strands agent...">Look around and describe what you see in detail.</textarea>
         
         <div class="turn-actions">
           <button id="runTurnBtn" class="run-turn-btn">üéÆ Run Turn</button>
           <select id="personaSelect" class="persona-select">
             <option value="explorer">Explorer</option>
             <option value="cautious">Cautious</option>
             <option value="social">Social</option>
             <option value="wanderer">Wanderer</option>
             <option value="guardian">Guardian</option>
           </select>
         </div>

         <div id="turnResult" class="turn-result" style="display: none;">
           <div id="resultText" class="result-text"></div>
           <div id="resultMeta" class="result-meta"></div>
         </div>
       </div>
     </div>

     <!-- Persona Tab -->
     <div id="t-persona" class="tab">
       <div class="persona-card">
         <div class="persona-summary" onclick="togglePersona()">
           <div class="persona-name">STRANDS AGENT</div>
           <div class="persona-tagline">AI-powered character in Unreal Engine ‚Üï</div>
         </div>
         <div id="persona-details" class="persona-details">
           <div class="persona-section">
             <div class="section-title">Current Persona</div>
             <div id="currentPersonaText" class="section-text">Explorer - Adventurous spirit who loves discovering new places</div>
           </div>
           <div class="persona-section">
             <div class="section-title">Capabilities</div>
             <div class="section-text">Movement, interaction, screenshot analysis, environment awareness, goal-oriented behavior</div>
           </div>
           <div class="persona-section">
             <div class="section-title">Integration</div>
             <div class="section-text">Real-time streaming ‚Ä¢ S3 storage ‚Ä¢ Turn-based gameplay ‚Ä¢ Session persistence</div>
           </div>
         </div>
       </div>
     </div>

     <!-- Stream Tab -->
     <div id="t-stream" class="tab">
       <div class="consciousness-stream">
         <div class="stream-header">
           <div class="stream-title">Agent Thoughts</div>
           <div id="streamStatus" class="stream-status">‚óè Waiting</div>
         </div>
         <div class="stream-content" id="streamContent">
           <div class="stream-line">Strands agent ready. Click "Run Turn" to begin...</div>
         </div>
       </div>
     </div>

     <!-- History Tab -->
     <div id="t-history" class="tab">
       <div id="historyContent">
         <div class="stream-line">Turn history will appear here...</div>
       </div>
     </div>
   </div>
 </div>
 
<script>
(function() {
  const video = document.getElementById('player');
  const toast = document.getElementById('toast');
  function showToast(msg) { 
    toast.textContent = msg; 
    toast.classList.add('show'); 
    setTimeout(() => toast.classList.remove('show'), 2500); 
  }

  // Strands Agent Integration
  class StrandsAgentClient {
    constructor() {
      // Use your API server URL here - modify this to point to your deployed API
      this.apiUrl = 'http://localhost:8001'; // Change to your API server URL
      this.websocket = null;
      this.sessionId = this.generateSessionId();
      this.currentTurn = null;
      this.turnHistory = [];
      this.isConnected = false;
    }

    generateSessionId() {
      const key = 'strandsSessionId';
      let v = sessionStorage.getItem(key);
      if (!v) {
        v = 'strands-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        sessionStorage.setItem(key, v);
      }
      return v;
    }

    async startTurn(prompt, persona = 'explorer') {
      const personas = {
        explorer: {
          archetype: "explorer",
          base_emotion: "excited", 
          personality: "Adventurous spirit who loves discovering new places",
          goals: ["explore", "climb", "discover secrets"]
        },
        cautious: {
          archetype: "cautious",
          base_emotion: "careful",
          personality: "Thoughtful observer who moves deliberately",
          goals: ["assess", "plan", "stay safe"]
        },
        social: {
          archetype: "social", 
          base_emotion: "friendly",
          personality: "Outgoing character who seeks interaction",
          goals: ["communicate", "help others", "build relationships"]
        },
        wanderer: {
          archetype: "wanderer",
          base_emotion: "whimsical", 
          personality: "A dreamy soul who sees magic in everything",
          goals: ["find beauty", "contemplate existence", "follow curiosity"]
        },
        guardian: {
          archetype: "guardian",
          base_emotion: "protective",
          personality: "Watchful protector focused on safety",
          goals: ["protect", "guard", "maintain order"]
        }
      };

      try {
        const response = await fetch(`${this.apiUrl}/api/start_turn`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            prompt: prompt,
            session_id: this.sessionId,
            persona_traits: personas[persona] || personas.explorer
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        this.currentTurn = result;
        return result;
      } catch (error) {
        console.error('Failed to start turn:', error);
        throw error;
      }
    }

    async getTurnStatus(turnId) {
      try {
        const response = await fetch(`${this.apiUrl}/api/turn_status/${turnId}`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return await response.json();
      } catch (error) {
        console.error('Failed to get turn status:', error);
        throw error;
      }
    }

    connectWebSocket() {
      if (this.websocket) {
        this.websocket.close();
      }

      try {
        const wsUrl = this.apiUrl.replace('http://', 'ws://').replace('https://', 'wss://');
        this.websocket = new WebSocket(`${wsUrl}/ws/${this.sessionId}`);
        
        this.websocket.onopen = () => {
          console.log('WebSocket connected to Strands API');
          this.isConnected = true;
          this.updateStreamStatus('Connected');
        };

        this.websocket.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            this.handleWebSocketMessage(data);
          } catch (error) {
            console.error('Failed to parse WebSocket message:', error);
          }
        };

        this.websocket.onclose = () => {
          console.log('WebSocket disconnected');
          this.isConnected = false;
          this.updateStreamStatus('Disconnected');
          // Retry connection after 5 seconds
          setTimeout(() => this.connectWebSocket(), 5000);
        };

        this.websocket.onerror = (error) => {
          console.error('WebSocket error:', error);
          this.updateStreamStatus('Error');
        };
      } catch (error) {
        console.error('Failed to connect WebSocket:', error);
        this.updateStreamStatus('Failed to connect');
      }
    }

    handleWebSocketMessage(data) {
      switch(data.type) {
        case 'turn_update':
        case 'status_update':
          this.updateTurnDisplay(data.data);
          break;
        case 'pong':
          // Keep-alive response
          break;
        default:
          console.log('Unknown WebSocket message:', data);
      }
    }

    updateTurnDisplay(turnData) {
      const statusEl = document.getElementById('turnStatus');
      const resultEl = document.getElementById('turnResult');
      const resultText = document.getElementById('resultText');
      const resultMeta = document.getElementById('resultMeta');

      if (turnData.status) {
        statusEl.textContent = turnData.status.charAt(0).toUpperCase() + turnData.status.slice(1);
        statusEl.className = `turn-status status-${turnData.status}`;
      }

      if (turnData.status === 'completed' && turnData.agent_response) {
        resultText.textContent = turnData.agent_response;
        
        let metaHtml = `Turn: ${turnData.turn_id} ‚Ä¢ ${turnData.timestamp}`;
        if (turnData.s3_urls) {
          if (turnData.s3_urls.screenshot) {
            metaHtml += `<br><a href="${turnData.s3_urls.screenshot}" target="_blank" class="s3-link">üì∏ Screenshot</a>`;
          }
          if (turnData.s3_urls.env_state) {
            metaHtml += `<a href="${turnData.s3_urls.env_state}" target="_blank" class="s3-link">üìä State</a>`;
          }
          if (turnData.s3_urls.turn_data) {
            metaHtml += `<a href="${turnData.s3_urls.turn_data}" target="_blank" class="s3-link">üìÑ Data</a>`;
          }
        }
        resultMeta.innerHTML = metaHtml;
        resultEl.style.display = 'block';

        // Add to history
        this.turnHistory.unshift({
          prompt: turnData.prompt,
          response: turnData.agent_response,
          timestamp: turnData.timestamp,
          turnId: turnData.turn_id,
          s3_urls: turnData.s3_urls
        });
        this.updateHistoryDisplay();

        // Update stream
        this.addToStream(`Turn completed: ${turnData.agent_response}`);
      } else if (turnData.status === 'error') {
        resultText.textContent = `Error: ${turnData.error_message || 'Unknown error occurred'}`;
        resultMeta.textContent = `Turn: ${turnData.turn_id} ‚Ä¢ Failed`;
        resultEl.style.display = 'block';
        this.addToStream(`Turn failed: ${turnData.error_message}`);
      } else if (turnData.status === 'running') {
        this.addToStream('Agent is processing turn...');
      }
    }

    updateStreamStatus(status) {
      const statusEl = document.getElementById('streamStatus');
      if (statusEl) {
        statusEl.textContent = `‚óè ${status}`;
        statusEl.style.color = this.isConnected ? '#36d38c' : '#ef4444';
      }
    }

    addToStream(message) {
      const streamContent = document.getElementById('streamContent');
      const streamLine = document.createElement('div');
      streamLine.className = 'stream-line';
      streamLine.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      streamContent.appendChild(streamLine);
      streamContent.scrollTop = streamContent.scrollHeight;

      // Keep only last 50 messages
      while (streamContent.children.length > 50) {
        streamContent.removeChild(streamContent.firstChild);
      }
    }

    updateHistoryDisplay() {
      const historyContent = document.getElementById('historyContent');
      if (this.turnHistory.length === 0) {
        historyContent.innerHTML = '<div class="stream-line">Turn history will appear here...</div>';
        return;
      }

      historyContent.innerHTML = this.turnHistory.map(turn => `
        <div class="history-item">
          <div class="history-prompt">Prompt: ${this.escapeHtml(turn.prompt)}</div>
          <div class="history-response">${this.escapeHtml(turn.response)}</div>
          <div class="history-meta">
            ${turn.timestamp} ‚Ä¢ ${turn.turnId}
            ${turn.s3_urls && turn.s3_urls.screenshot ? `‚Ä¢ <a href="${turn.s3_urls.screenshot}" target="_blank" class="s3-link">Screenshot</a>` : ''}
          </div>
        </div>
      `).join('');
    }

    escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  }

  // Initialize Strands client
  const strandsClient = new StrandsAgentClient();
  
  // Connect WebSocket
  strandsClient.connectWebSocket();

  // Persona toggle function
  window.togglePersona = function() {
    const details = document.getElementById('persona-details');
    details.classList.toggle('expanded');
  };

  // Update persona display
  function updatePersonaDisplay(persona) {
    const personas = {
      explorer: "Explorer - Adventurous spirit who loves discovering new places",
      cautious: "Cautious - Thoughtful observer who moves deliberately", 
      social: "Social - Outgoing character who seeks interaction",
      wanderer: "Wanderer - A dreamy soul who sees magic in everything",
      guardian: "Guardian - Watchful protector focused on safety"
    };
    
    const personaText = document.getElementById('currentPersonaText');
    if (personaText) {
      personaText.textContent = personas[persona] || personas.explorer;
    }
  }

  // Wire up Run Turn functionality
  const runTurnBtn = document.getElementById('runTurnBtn');
  const promptInput = document.getElementById('promptInput');
  const personaSelect = document.getElementById('personaSelect');

  if (runTurnBtn && promptInput) {
    runTurnBtn.addEventListener('click', async () => {
      const prompt = promptInput.value.trim();
      const persona = personaSelect ? personaSelect.value : 'explorer';
      
      if (!prompt) {
        showToast('Please enter a prompt');
        return;
      }

      runTurnBtn.disabled = true;
      runTurnBtn.textContent = '‚è≥ Running...';
      
      try {
        strandsClient.addToStream(`Starting turn: ${prompt}`);
        const result = await strandsClient.startTurn(prompt, persona);
        showToast(`Turn started: ${result.turn_id}`);
        
        // Update persona display
        updatePersonaDisplay(persona);
        
        // Poll for status updates
        const pollStatus = async () => {
          try {
            const status = await strandsClient.getTurnStatus(result.turn_id);
            strandsClient.updateTurnDisplay(status);
            
            if (status.status === 'running' || status.status === 'pending') {
              setTimeout(pollStatus, 2000); // Poll every 2 seconds
            } else {
              runTurnBtn.disabled = false;
              runTurnBtn.textContent = 'üéÆ Run Turn';
            }
          } catch (error) {
            console.error('Failed to poll status:', error);
            runTurnBtn.disabled = false;
            runTurnBtn.textContent = 'üéÆ Run Turn';
          }
        };
        
        setTimeout(pollStatus, 1000);
        
      } catch (error) {
        console.error('Turn failed:', error);
        showToast(`Turn failed: ${error.message}`);
        strandsClient.addToStream(`Turn failed: ${error.message}`);
        runTurnBtn.disabled = false;
        runTurnBtn.textContent = 'üéÆ Run Turn';
      }
    });
  }

  // Update persona when selection changes
  if (personaSelect) {
    personaSelect.addEventListener('change', () => {
      updatePersonaDisplay(personaSelect.value);
    });
  }

  // Video player setup (from original)
  const urlParams = new URLSearchParams(window.location.search);
  const srcParam = urlParams.get('src');
  const defaultLive = 'https://ccf3786b925ee51c.mediapackage.us-east-1.amazonaws.com/out/v1/f7dd6e8b0ee74ff4954fcc90c4e138b8/index.m3u8';
  const fallbackVod = window.location.origin + '/assets/sample.mp4';
  const sources = srcParam ? [srcParam] : [defaultLive, fallbackVod];
  let current = 0;
  function isHls(u) { return /\.m3u8(\?.*)?$/i.test(u); }
  function tryNext() {
    if (current >= sources.length) { showToast('No playable source found'); return; }
    const src = sources[current++];
    if (isHls(src)) {
      if (window.Hls && window.Hls.isSupported()) {
        const hls = new Hls({ lowLatencyMode: false, enableWorker: true });
        hls.on(Hls.Events.ERROR, (e, data) => {
          if (data.fatal) { hls.destroy(); showToast('HLS error, falling back'); tryNext(); }
        });
        hls.loadSource(src);
        hls.attachMedia(video);
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = src;
      } else {
        showToast('HLS not supported, falling back'); tryNext(); return;
      }
    } else {
      video.src = src;
    }
  }
  video.addEventListener('error', () => { showToast('Playback error, trying next source'); tryNext(); });
  tryNext();

  // Tabs switching
  const controlPanel = document.getElementById('controlPanel');
  if (controlPanel) {
    controlPanel.addEventListener('click', (ev) => {
      const btn = ev.target.closest('.tab-btn');
      if (!btn) return;
      const target = btn.getAttribute('data-tab');
      for (const b of controlPanel.querySelectorAll('.tab-btn')) b.classList.remove('active');
      btn.classList.add('active');
      for (const t of controlPanel.querySelectorAll('.tab')) t.classList.remove('active');
      const tabEl = controlPanel.querySelector('#' + target);
      if (tabEl) tabEl.classList.add('active');
    });
  }

  // Initialize
  strandsClient.addToStream('Strands Agent Client initialized');
  updatePersonaDisplay('explorer');

})();
</script>
</body>
</html>